<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Podiatry Tracker App</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    .section {
      margin-bottom: 20px;
      padding: 10px;
      border: 1px solid #ccc;
    }
    .section h2 {
      margin-top: 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    table, th, td {
      border: 1px solid #444;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #f0f0f0;
      user-select: none;
    }
    th.fixed {
      background-color: #ddd;
      cursor: default;
    }
    /* Group header styling */
    thead tr.group-header th {
      background-color: #ddd;
      font-weight: bold;
    }
    button {
      padding: 5px 10px;
      cursor: pointer;
      margin: 5px;
    }
    /* When a procedure button is toggled, give it a grey background */
    button.done {
      background-color: #ccc;
      color: white;
    }
    input[type="text"] {
      padding: 5px;
    }
    #exportInstructions {
      margin-top: 20px;
      font-weight: bold;
      font-size: 16px;
      color: #333;
    }
    .auth-options button {
      margin-right: 5px;
      padding: 3px 7px;
      font-size: 90%;
    }
    .auth-message {
      margin-top: 5px;
      font-weight: bold;
    }
  </style>
  <!-- Include Tesseract.js for OCR processing -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@v2.1.5/dist/tesseract.min.js"></script>
</head>
<body>
  <h1>Podiatry Tracker App</h1>
  <p>
    Use this app to track the items and services dispensed. You can preview sample names, add patient names manually, or upload names via OCR.
  </p>

  <!-- Preview Sample Names Section -->
  <div id="previewSection" class="section">
    <h2>Preview Sample Names</h2>
    <p>Click the button below to populate the table with sample patient names.</p>
    <button id="previewButton">Preview Sample Names</button>
  </div>

  <!-- Manual Entry Section -->
  <div id="manualSection" class="section">
    <h2>Manually Add Patient</h2>
    <p>Enter a patient's name and click "Add Patient" to add it to the table.</p>
    <input type="text" id="manualName" placeholder="First Last">
    <button id="manualAddButton">Add Patient</button>
  </div>

  <!-- OCR Upload Section -->
  <div id="uploadSection" class="section">
    <h2>Upload Patient Names from Image (OCR)</h2>
    <p>Upload an image file (screenshot) that contains patient names (one per line). The OCR process will extract the names and add them to the table.</p>
    <input type="file" id="fileInput" accept="image/*">
    <button id="uploadButton">Upload and Process OCR</button>
    <p id="status"></p>
  </div>

  <!-- Data Table with Grouped Headers -->
  <table id="patientsTable">
    <thead>
      <!-- Group Header Row -->
      <tr class="group-header">
        <th rowspan="2" class="fixed">Patient</th>
        <th rowspan="2" class="fixed">New?</th>
        <th colspan="3">DME</th>
        <th rowspan="2">Casting</th>
        <th colspan="2">IMAGING</th>
        <th colspan="3">Office Procedures</th>
        <th rowspan="2">Ordering Diabetic Shoes</th>
        <th rowspan="2">Notes</th>
        <th rowspan="2">Actions</th>
      </tr>
      <!-- Individual Column Header Row -->
      <tr>
        <th>Night Splint</th>
        <th>CAM Walker</th>
        <th>ASO Brace</th>
        <th>X-Rays</th>
        <th>Ultrasound</th>
        <th>Nail Procedure</th>
        <th>Routine Care</th>
        <th>Injection</th>
      </tr>
    </thead>
    <tbody>
      <!-- Table rows are populated dynamically -->
    </tbody>
  </table>

  <!-- Google API Sign In/Out, Export, and Open Spreadsheet Buttons -->
  <button id="signInButton" onclick="handleSignInClick()">Sign In with Google</button>
  <button id="signOutButton" onclick="handleSignOutClick()" style="display:none;">Sign Out</button>
  <button id="exportButton" onclick="exportToSheet()" disabled>Export to Google Sheets (with login)</button>
  <button id="exportNoLoginButton" onclick="exportWithoutLogin()">Export without logging into your Google account</button>
  <button id="openSheetButton" onclick="window.location.href='https://docs.google.com/spreadsheets/d/1afikn7dpw-QnO3KQVBsUtRceeHslzd7VDoBPHnZiGFk/edit?usp=sharing'">Open Spreadsheet</button>

  <!-- Export Instructions -->
  <div id="exportInstructions">
    <p>Instructions: To export with login, sign in and click "Export to Google Sheets (with login)". Otherwise, click "Export without logging into your Google account" and then verify your data by clicking "Open Spreadsheet".</p>
  </div>

  <!-- JavaScript for Table, Export, and Google API Functions -->
  <script>
    // --- Table functions ---
    function populateTable(names) {
      const tbody = document.querySelector("#patientsTable tbody");
      tbody.innerHTML = "";
      names.forEach(function(name) {
        const trimmedName = name.trim();
        if (trimmedName !== "") {
          tbody.appendChild(createRow(trimmedName));
        }
      });
      enableColumnDragAndDrop();
    }
    
    function addRow(name) {
      const tbody = document.querySelector("#patientsTable tbody");
      const trimmedName = name.trim();
      if (trimmedName !== "") {
        tbody.appendChild(createRow(trimmedName));
        enableColumnDragAndDrop();
      }
    }
    
    // Create a row following the new column order:
    // Patient, New?, DME (Night Splint, CAM Walker, ASO Brace), Casting, IMAGING (X-Rays, Ultrasound),
    // Office Procedures (Nail Procedure, Routine Care, Injection), Ordering Diabetic Shoes, Notes, Actions.
    function createRow(name) {
      const tr = document.createElement("tr");
      
      // Patient cell
      const tdPatient = document.createElement("td");
      tdPatient.textContent = name;
      tr.appendChild(tdPatient);
      
      // New? checkbox cell
      const tdNew = document.createElement("td");
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.title = "Check if new patient";
      tdNew.appendChild(checkbox);
      tr.appendChild(tdNew);
      
      // DME group: Night Splint, CAM Walker, ASO Brace
      const dmeProcedures = ["Night Splint", "CAM Walker", "ASO Brace"];
      dmeProcedures.forEach(function(proc) {
        const td = document.createElement("td");
        const btn = document.createElement("button");
        btn.textContent = "Mark Done";
        btn.dataset.service = proc;
        btn.addEventListener("click", function() {
          toggleButton(btn);
        });
        td.appendChild(btn);
        tr.appendChild(td);
      });
      
      // Casting column (with special casting handling)
      const tdCasting = document.createElement("td");
      const containerCasting = document.createElement("div");
      const castButton = document.createElement("button");
      castButton.textContent = "Mark Done";
      castButton.addEventListener("click", function() {
        toggleCasting(castButton, containerCasting);
      });
      containerCasting.appendChild(castButton);
      tdCasting.appendChild(containerCasting);
      tr.appendChild(tdCasting);
      
      // IMAGING group: X-Rays, Ultrasound
      const imagingProcedures = ["X-Rays", "Ultrasound"];
      imagingProcedures.forEach(function(proc) {
        const td = document.createElement("td");
        const btn = document.createElement("button");
        btn.textContent = "Mark Done";
        btn.dataset.service = proc;
        btn.addEventListener("click", function() {
          toggleButton(btn);
        });
        td.appendChild(btn);
        tr.appendChild(td);
      });
      
      // Office Procedures group: Nail Procedure, Routine Care, Injection
      const officeProcedures = ["Nail Procedure", "Routine Care", "Injection"];
      officeProcedures.forEach(function(proc) {
        const td = document.createElement("td");
        const btn = document.createElement("button");
        btn.textContent = "Mark Done";
        btn.dataset.service = proc;
        btn.addEventListener("click", function() {
          toggleButton(btn);
        });
        td.appendChild(btn);
        tr.appendChild(td);
      });
      
      // Ordering Diabetic Shoes column
      const tdODS = document.createElement("td");
      const btnODS = document.createElement("button");
      btnODS.textContent = "Mark Done";
      btnODS.dataset.service = "Ordering Diabetic Shoes";
      btnODS.addEventListener("click", function() {
        toggleButton(btnODS);
      });
      tdODS.appendChild(btnODS);
      tr.appendChild(tdODS);
      
      // Notes column: free-hand text input
      const tdNotes = document.createElement("td");
      const notesInput = document.createElement("input");
      notesInput.type = "text";
      notesInput.placeholder = "Enter notes...";
      tdNotes.appendChild(notesInput);
      tr.appendChild(tdNotes);
      
      // Actions column with Remove button
      const tdActions = document.createElement("td");
      const removeBtn = document.createElement("button");
      removeBtn.textContent = "Remove";
      removeBtn.classList.add("action-button");
      removeBtn.addEventListener("click", function() {
        tr.remove();
      });
      tdActions.appendChild(removeBtn);
      tr.appendChild(tdActions);
      
      return tr;
    }
    
    function toggleButton(button) {
      if (button.classList.contains("done")) {
        button.classList.remove("done");
        button.textContent = "Mark Done";
      } else {
        button.classList.add("done");
        button.textContent = "Done";
      }
    }
    
    function toggleCasting(button, container) {
      if (button.classList.contains("done")) {
        button.classList.remove("done");
        button.textContent = "Mark Done";
        const authOptions = container.querySelector(".auth-options");
        if (authOptions) container.removeChild(authOptions);
        const authMessage = container.querySelector(".auth-message");
        if (authMessage) container.removeChild(authMessage);
      } else {
        button.classList.add("done");
        button.textContent = "Done";
        let authOptions = container.querySelector(".auth-options");
        if (!authOptions) {
          authOptions = document.createElement("div");
          authOptions.className = "auth-options";
          authOptions.style.marginTop = "5px";
          const authButton = document.createElement("button");
          authButton.textContent = "Auth will be sent";
          const authNotNeededButton = document.createElement("button");
          authNotNeededButton.textContent = "Auth not needed";
          authOptions.appendChild(authButton);
          authOptions.appendChild(authNotNeededButton);
          container.appendChild(authOptions);
          const authMessage = document.createElement("div");
          authMessage.className = "auth-message";
          authMessage.style.marginTop = "5px";
          container.appendChild(authMessage);
          
          authButton.addEventListener("click", function() {
            const row = container.parentElement.parentElement;
            const patientName = row.cells[0].textContent;
            authMessage.textContent = "L3000 requested for " + patientName + ". Please copy and paste and send to Concepcion";
          });
          authNotNeededButton.addEventListener("click", function() {
            const authMessage = container.querySelector(".auth-message");
            authMessage.textContent = "";
          });
        }
      }
    }
    
    // --- Column Drag and Drop ---
    function enableColumnDragAndDrop() {
      const headerCells = document.querySelectorAll("#patientsTable thead tr:nth-child(2) th");
      headerCells.forEach((cell, index) => {
        // We allow dragging on the individual header row (not the group row)
        cell.draggable = true;
        cell.addEventListener("dragstart", handleDragStart);
        cell.addEventListener("dragover", handleDragOver);
        cell.addEventListener("drop", handleDrop);
      });
    }
    
    let draggedColIndex = null;
    function handleDragStart(e) {
      draggedColIndex = e.target.cellIndex;
      e.dataTransfer.setData("text/plain", draggedColIndex);
    }
    function handleDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = "move";
    }
    function handleDrop(e) {
      e.preventDefault();
      const targetColIndex = e.target.cellIndex;
      const sourceIndex = parseInt(e.dataTransfer.getData("text/plain"));
      if (sourceIndex !== targetColIndex) {
        reorderTableColumns(sourceIndex, targetColIndex);
        enableColumnDragAndDrop();
      }
    }
    function reorderTableColumns(fromIndex, toIndex) {
      const table = document.getElementById("patientsTable");
      const rows = table.rows;
      for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const cells = row.cells;
        let cell = cells[fromIndex + (i === 0 ? 0 : 0)]; // Note: Our header rows are separate, so this applies to tbody rows.
        let adjustedIndex = toIndex;
        if (fromIndex < toIndex) {
          adjustedIndex--;
        }
        row.removeChild(cell);
        if (adjustedIndex >= cells.length) {
          row.appendChild(cell);
        } else {
          row.insertBefore(cell, cells[adjustedIndex]);
        }
      }
    }
    
    // --- Event Listeners for Preview, Manual, OCR ---
    document.getElementById("previewButton").addEventListener("click", function() {
      const sampleNames = [
        "John Doe",
        "Jane Smith",
        "Alice Johnson",
        "Bob Brown",
        "Charlie Davis",
        "Emily Wilson",
        "Frank Miller",
        "Grace Lee",
        "Hannah Taylor",
        "Ian Clark"
      ];
      populateTable(sampleNames);
    });
    
    document.getElementById("manualAddButton").addEventListener("click", function() {
      const manualInput = document.getElementById("manualName");
      const name = manualInput.value;
      if (name.trim() === "") {
        alert("Please enter a valid name.");
        return;
      }
      addRow(name);
      manualInput.value = "";
    });
    
    document.getElementById("uploadButton").addEventListener("click", function() {
      const fileInput = document.getElementById("fileInput");
      const statusElem = document.getElementById("status");
      if (fileInput.files.length === 0) {
        alert("Please select an image file that contains patient names (one per line).");
        return;
      }
      const file = fileInput.files[0];
      statusElem.textContent = "Processing OCR, please wait...";
      Tesseract.recognize(file, "eng", { logger: m => console.log(m) })
        .then(({ data: { text } }) => {
          statusElem.textContent = "OCR processing complete.";
          const names = text.split(/\r?\n/);
          populateTable(names);
        })
        .catch(err => {
          console.error(err);
          statusElem.textContent = "Error during OCR processing.";
        });
    });
    
    // --- Google API Integration for Export with Login ---
    const CLIENT_ID = "274211132378-60hhu50rqigl58dd3lph2l6ot0crdkrf.apps.googleusercontent.com";
    const API_KEY = "AIzaSyBSsRF__f7e4LUkxO5msIAs8BC6hX92-eE";
    const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
    const SCOPES = "https://www.googleapis.com/auth/spreadsheets";
    
    function handleClientLoad() {
      gapi.load("client:auth2", initClient);
    }
    function initClient() {
      gapi.client.init({
        apiKey: API_KEY,
        clientId: CLIENT_ID,
        discoveryDocs: DISCOVERY_DOCS,
        scope: SCOPES
      }).then(function() {
        gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
        updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
        document.getElementById("exportButton").disabled = false;
      }, function(error) {
        console.error(JSON.stringify(error, null, 2));
      });
    }
    function updateSigninStatus(isSignedIn) {
      if (isSignedIn) {
        document.getElementById("signInButton").style.display = "none";
        document.getElementById("signOutButton").style.display = "block";
      } else {
        document.getElementById("signInButton").style.display = "block";
        document.getElementById("signOutButton").style.display = "none";
      }
    }
    function handleSignInClick(event) {
      gapi.auth2.getAuthInstance().signIn();
    }
    function handleSignOutClick(event) {
      gapi.auth2.getAuthInstance().signOut();
    }
    
    // Export using Google API (with login)
    function exportToSheet() {
      let data = [];
      // Get individual header row (from the second header row)
      const headerCells = document.querySelectorAll("#patientsTable thead tr:nth-child(2) th");
      let headerRow = [];
      headerCells.forEach(cell => {
        headerRow.push(cell.innerText.trim());
      });
      // Prepend the fixed columns that are only in the first row:
      // "Patient" and "New?" are not in the second row because they have rowspan="2"
      headerRow.unshift("New?");
      headerRow.unshift("Patient");
      data.push(headerRow);
      
      // Process table rows from tbody (skip last "Actions" cell)
      const rows = document.querySelectorAll("#patientsTable tbody tr");
      rows.forEach(row => {
        let rowData = [];
        // We assume the cells are in the same order as the final header:
        // Patient, New?, DME (3 columns), Casting, IMAGING (2 columns), Office Procedures (3 columns), Ordering Diabetic Shoes, Notes, Actions.
        const cells = row.querySelectorAll("td");
        // Skip last cell (Actions)
        for (let i = 0; i < cells.length - 1; i++) {
          let cellValue = "";
          // For procedure buttons and such:
          const btn = cells[i].querySelector("button");
          if (btn) {
            cellValue = btn.classList.contains("done") ? "1" : "0";
          } else {
            const checkbox = cells[i].querySelector("input[type='checkbox']");
            if (checkbox) {
              cellValue = checkbox.checked ? "Yes" : "No";
            } else {
              cellValue = cells[i].innerText.trim();
            }
          }
          rowData.push(cellValue);
        }
        data.push(rowData);
      });
      
      const spreadsheetId = "1afikn7dpw-QnO3KQVBsUtRceeHslzd7VDoBPHnZiGFk";
      const range = "Sheet1!A1";
      
      const params = {
        spreadsheetId: spreadsheetId,
        range: range,
        valueInputOption: "USER_ENTERED"
      };
      
      const valueRangeBody = {
        "values": data
      };
      
      gapi.client.sheets.spreadsheets.values.append(params, valueRangeBody).then(
        response => {
          console.log(response.result);
          alert("Data exported to Google Sheets successfully!");
        },
        err => {
          console.error("Error: " + err.result.error.message);
          alert("Failed to export data: " + err.result.error.message);
        }
      );
    }
    
    // Export without login (using fetch and no-cors)
    function exportWithoutLogin() {
      let data = [];
      // Get individual header row from second header row
      const headerCells = document.querySelectorAll("#patientsTable thead tr:nth-child(2) th");
      let headerRow = [];
      headerCells.forEach(cell => {
        headerRow.push(cell.innerText.trim());
      });
      // Prepend the fixed columns: Patient and New?
      headerRow.unshift("New?");
      headerRow.unshift("Patient");
      data.push(headerRow);
      
      // Process table rows (skip last "Actions" cell)
      const rows = document.querySelectorAll("#patientsTable tbody tr");
      rows.forEach(row => {
        let rowData = [];
        const cells = row.querySelectorAll("td");
        for (let i = 0; i < cells.length - 1; i++) {
          let cellValue = "";
          const btn = cells[i].querySelector("button");
          if (btn) {
            cellValue = btn.classList.contains("done") ? "1" : "0";
          } else {
            const checkbox = cells[i].querySelector("input[type='checkbox']");
            if (checkbox) {
              cellValue = checkbox.checked ? "Yes" : "No";
            } else {
              cellValue = cells[i].innerText.trim();
            }
          }
          rowData.push(cellValue);
        }
        data.push(rowData);
      });
      
      fetch("https://script.google.com/macros/s/AKfycbzddIS9_h0H69lFwmkuroaujNiLVaqgoPWSYAHAKPFksJ1pSlLjLZoc0UE-BMDXNqav/exec", {
        method: "POST",
        mode: "no-cors",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(data)
      })
      .then(response => {
        alert("Data exported without login successfully! (Response is opaque; please verify in your spreadsheet.)");
      })
      .catch(error => {
        console.error("Error exporting without login:", error);
        alert("Error exporting data: " + error);
      });
    }
    
    document.addEventListener("DOMContentLoaded", function() {
      enableColumnDragAndDrop();
    });
    
    // Load Google API client
    function handleClientLoad() {
      gapi.load("client:auth2", initClient);
    }
    handleClientLoad();
  </script>
  <script src="https://apis.google.com/js/api.js"></script>
</body>
</html>
